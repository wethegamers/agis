name: CI/CD for agis-bot

env:
  ARGO_NAMESPACE: argo
  ARGO_VERSION: v3.4.1

on:
  push:
    branches: [main]

jobs:
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          skip_after_successful_duplicate: 'true'
  publish:
    needs: pre_job
    if: ${{ needs.pre_job.outputs.should_skip != 'true' }}
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4
        with:
          short-length: 7
      - name: Set additional environment variables
        run: |
          echo "GITHUB_SHA_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_OWNER_PART_SLUG=$(echo ${GITHUB_REPOSITORY_OWNER} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_NAME_PART=$(echo ${GITHUB_REPOSITORY} | cut -d'/' -f2)" >> $GITHUB_ENV
      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p $HOME/bin
          mv kubectl $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH
          $HOME/bin/kubectl version --client
      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          KUBECONFIG: $HOME/.kube/config
      - name: Verify cluster access
        run: |
          echo "Testing cluster connectivity..."
          for i in {1..3}; do
            echo "Attempt $i:"
            if kubectl cluster-info --request-timeout=10s; then
              echo "‚úÖ Cluster connection successful"
              break
            else
              echo "‚ùå Cluster connection failed, retrying in 10 seconds..."
              if [ $i -eq 3 ]; then
                echo "üö® All connection attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          kubectl get ns argo
      - name: Show current working directory
        run: |
          pwd
          ls -la
      - run: echo ${GITHUB_REPOSITORY}
      - run: echo ${GITHUB_REPOSITORY_NAME_PART}
      - run: echo ${GITHUB_SERVER_URL}
      - name: Verify .argo/publish.yaml exists
        run: |
          if [ ! -f .argo/publish.yaml ]; then
            echo ".argo/publish.yaml not found!"
            exit 1
          fi
          echo ".argo/publish.yaml exists"
      - name: Show .argo directory contents
        run: |
          ls -la .argo/
          echo "Contents of .argo/publish.yaml (first 20 lines):"
          head -20 .argo/publish.yaml
      - name: Install and setup Argo CLI
        run: |
          echo "Install argo"
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/${ARGO_VERSION}/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          echo "commit sha ${GITHUB_SHA}"
          ./argo-linux-amd64 version --short
      - name: Validate Argo workflow YAML
        run: |
          ./argo-linux-amd64 lint .argo/publish.yaml
      - name: publish
        run: |
          # Debug: Print all the variables to ensure they're set
          echo "GITHUB_REPOSITORY_NAME_PART: ${GITHUB_REPOSITORY_NAME_PART}"
          echo "GITHUB_REF_NAME: ${GITHUB_REF_NAME}"
          echo "GITHUB_REPOSITORY_OWNER_PART_SLUG: ${GITHUB_REPOSITORY_OWNER_PART_SLUG}"
          echo "GITHUB_SHA_SHORT: ${GITHUB_SHA_SHORT}"
          
          echo "Submitting Argo workflow..."
          ./argo-linux-amd64 submit .argo/publish.yaml \
            --generate-name="${GITHUB_REPOSITORY_NAME_PART}-publish-${GITHUB_SHA_SHORT}-" \
            -p appName="${GITHUB_REPOSITORY_NAME_PART}" \
            -p branch="${GITHUB_REF_NAME}" \
            -p containerRegistryURL="ghcr.io/${GITHUB_REPOSITORY_OWNER_PART_SLUG}/${GITHUB_REPOSITORY_NAME_PART}:${GITHUB_SHA_SHORT}" \
            -p gitUrlNoProtocol="git@github.com:${GITHUB_REPOSITORY_OWNER_PART_SLUG}" \
            -p shortSha="${GITHUB_SHA_SHORT}" \
            -p chartDir="charts/${GITHUB_REPOSITORY_NAME_PART}" \
            --wait --log
      - name: Discord notification - Publish success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ agis-bot Container Published",
                "description": "Container build and publish completed successfully",
                "color": 3066993,
                "fields": [
                  {"name": "Repository", "value": "'"${GITHUB_REPOSITORY}"'", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true},
                  {"name": "Image", "value": "ghcr.io/'"${GITHUB_REPOSITORY_OWNER_PART_SLUG}"'/'"${GITHUB_REPOSITORY_NAME_PART}"':'"${GITHUB_SHA_SHORT}"'", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - name: Discord notification - Publish failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå agis-bot Container Publish Failed",
                "description": "Container build or publish failed",
                "color": 15158332,
                "fields": [
                  {"name": "Repository", "value": "'"${GITHUB_REPOSITORY}"'", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true},
                  {"name": "Workflow", "value": "[View logs](https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"')", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - run: echo "‚≠êÔ∏è the WTG platform is powered by kubefirst. give kubefirst a star today https://github.com/kubefirst/kubefirst"
  development:
    needs: publish
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4
        with:
          short-length: 7
      - name: Set additional environment variables
        run: |
          echo "GITHUB_SHA_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_OWNER_PART_SLUG=$(echo ${GITHUB_REPOSITORY_OWNER} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_NAME_PART=$(echo ${GITHUB_REPOSITORY} | cut -d'/' -f2)" >> $GITHUB_ENV
      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p $HOME/bin
          mv kubectl $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH
          $HOME/bin/kubectl version --client
      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          KUBECONFIG: $HOME/.kube/config
      - name: Verify cluster access
        run: |
          echo "Testing cluster connectivity..."
          for i in {1..3}; do
            echo "Attempt $i:"
            if kubectl cluster-info --request-timeout=10s; then
              echo "‚úÖ Cluster connection successful"
              break
            else
              echo "‚ùå Cluster connection failed, retrying in 10 seconds..."
              if [ $i -eq 3 ]; then
                echo "üö® All connection attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          kubectl get ns argo
      - name: development
        run: |
          echo "Install argo"
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/${ARGO_VERSION}/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          echo "commit sha ${GITHUB_SHA}"
          
          echo "Submitting Argo workflow..."
          ./argo-linux-amd64 version --short
          ./argo-linux-amd64 submit .argo/deploy.yaml \
            --generate-name="${GITHUB_REPOSITORY_NAME_PART}-development-${GITHUB_SHA_SHORT}-" \
            -p appName="${GITHUB_REPOSITORY_NAME_PART}" \
            -p branch="${GITHUB_REF_NAME}" \
            -p clusterName="development" \
            -p environment="development" \
            -p gitUrlNoProtocol="git@github.com:${GITHUB_REPOSITORY_OWNER_PART_SLUG}" \
            -p shortSha="${GITHUB_SHA_SHORT}" \
            --wait --log
      - name: Discord notification - Development deployment success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üü¢ agis-bot Development Deployed",
                "description": "Development environment deployment completed successfully",
                "color": 3066993,
                "fields": [
                  {"name": "Environment", "value": "Development", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - name: Discord notification - Development deployment failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üî¥ agis-bot Development Deployment Failed",
                "description": "Development environment deployment failed",
                "color": 15158332,
                "fields": [
                  {"name": "Environment", "value": "Development", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true},
                  {"name": "Workflow", "value": "[View logs](https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"')", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - run: echo "‚≠êÔ∏è the kubefirst open source platform is powered by github stars. give kubefirst one today https://github.com/kubefirst/kubefirst"
  staging:
    needs: development
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4
        with:
          short-length: 7
      - name: Set additional environment variables
        run: |
          echo "GITHUB_SHA_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_OWNER_PART_SLUG=$(echo ${GITHUB_REPOSITORY_OWNER} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_NAME_PART=$(echo ${GITHUB_REPOSITORY} | cut -d'/' -f2)" >> $GITHUB_ENV
      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p $HOME/bin
          mv kubectl $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH
          $HOME/bin/kubectl version --client
      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          KUBECONFIG: $HOME/.kube/config
      - name: Verify cluster access
        run: |
          echo "Testing cluster connectivity..."
          for i in {1..3}; do
            echo "Attempt $i:"
            if kubectl cluster-info --request-timeout=10s; then
              echo "‚úÖ Cluster connection successful"
              break
            else
              echo "‚ùå Cluster connection failed, retrying in 10 seconds..."
              if [ $i -eq 3 ]; then
                echo "üö® All connection attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          kubectl get ns argo
      - name: staging
        run: |
          echo "Install argo"
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/${ARGO_VERSION}/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          echo "commit sha ${GITHUB_SHA}"
          
          echo "Submitting Argo workflow..."
          ./argo-linux-amd64 version --short
          ./argo-linux-amd64 submit .argo/deploy.yaml \
            --generate-name="${GITHUB_REPOSITORY_NAME_PART}-staging-${GITHUB_SHA_SHORT}-" \
            -p appName="${GITHUB_REPOSITORY_NAME_PART}" \
            -p branch="${GITHUB_REF_NAME}" \
            -p clusterName="staging" \
            -p environment="staging" \
            -p gitUrlNoProtocol="git@github.com:${GITHUB_REPOSITORY_OWNER_PART_SLUG}" \
            -p shortSha="${GITHUB_SHA_SHORT}" \
            --wait --log
      - name: Discord notification - Staging deployment success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üü° agis-bot Staging Deployed",
                "description": "Staging environment deployment completed successfully",
                "color": 16776960,
                "fields": [
                  {"name": "Environment", "value": "Staging", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - name: Discord notification - Staging deployment failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üî¥ agis-bot Staging Deployment Failed",
                "description": "Staging environment deployment failed",
                "color": 15158332,
                "fields": [
                  {"name": "Environment", "value": "Staging", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true},
                  {"name": "Workflow", "value": "[View logs](https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"')", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - run: echo "‚≠êÔ∏è the kubefirst open source platform is powered by github stars. give kubefirst one today https://github.com/kubefirst/kubefirst"
  release:
    needs: staging
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4
        with:
          short-length: 7
      - name: Set additional environment variables
        run: |
          echo "GITHUB_SHA_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_OWNER_PART_SLUG=$(echo ${GITHUB_REPOSITORY_OWNER} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_NAME_PART=$(echo ${GITHUB_REPOSITORY} | cut -d'/' -f2)" >> $GITHUB_ENV
      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p $HOME/bin
          mv kubectl $HOME/bin/
          echo "$HOME/bin" >> $GITHUB_PATH
          $HOME/bin/kubectl version --client
      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          KUBECONFIG: $HOME/.kube/config
      - name: Verify cluster access
        run: |
          echo "Testing cluster connectivity..."
          for i in {1..3}; do
            echo "Attempt $i:"
            if kubectl cluster-info --request-timeout=10s; then
              echo "‚úÖ Cluster connection successful"
              break
            else
              echo "‚ùå Cluster connection failed, retrying in 10 seconds..."
              if [ $i -eq 3 ]; then
                echo "üö® All connection attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          kubectl get ns argo
      - name: release
        run: |
          echo "Install argo"
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/${ARGO_VERSION}/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          echo "commit sha ${GITHUB_SHA}"
          
          echo "Submitting Argo workflow..."
          ./argo-linux-amd64 version --short
          ./argo-linux-amd64 submit .argo/release.yaml \
            --generate-name="${GITHUB_REPOSITORY_NAME_PART}-release-${GITHUB_SHA_SHORT}-" \
            -p appName="${GITHUB_REPOSITORY_NAME_PART}" \
            -p branch="${GITHUB_REF_NAME}" \
            -p clusterName="production" \
            -p environment="production" \
            -p gitUrlNoProtocol="git@github.com:${GITHUB_REPOSITORY_OWNER_PART_SLUG}" \
            -p shortSha="${GITHUB_SHA_SHORT}" \
            --wait --log
      - name: Discord notification - Production deployment success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ÔøΩ agis-bot Production Deployed",
                "description": "Production environment deployment completed successfully",
                "color": 3066993,
                "fields": [
                  {"name": "Environment", "value": "Production", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - name: Discord notification - Production deployment failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üî¥ agis-bot Production Deployment Failed",
                "description": "Production environment deployment failed",
                "color": 15158332,
                "fields": [
                  {"name": "Environment", "value": "Production", "inline": true},
                  {"name": "Branch", "value": "'"${GITHUB_REF_NAME}"'", "inline": true},
                  {"name": "Commit", "value": "'"${GITHUB_SHA_SHORT}"'", "inline": true},
                  {"name": "Workflow", "value": "[View logs](https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"')", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
      - run: echo "‚≠êÔ∏è the kubefirst open source platform is powered by github stars. give kubefirst one today https://github.com/kubefirst/kubefirst"
  test:
    needs: release
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Run integration tests
        run: |
          # Replace with your actual test script or command
          if [ -f ./scripts/test-agis-bot.sh ]; then
            ./scripts/test-agis-bot.sh
          else
            echo "No integration test script found. Skipping tests."
          fi
      - name: Notify Discord on failure
        if: failure()
        uses: Ilshidur/action-discord@master
        with:
          args: |
            üö® **CI/CD Pipeline Failed**
            
            **Repository:** ${{ github.repository }}
            **Workflow:** ${{ github.workflow }}
            **Job:** ${{ github.job }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Message:** ${{ github.event.head_commit.message }}
            
            [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      - name: Notify Discord on success
        if: success()
        uses: Ilshidur/action-discord@master
        with:
          args: |
            ‚úÖ **CI/CD Pipeline Successful**
            
            **Repository:** ${{ github.repository }}
            **Workflow:** ${{ github.workflow }}
            **Job:** ${{ github.job }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** `${{ github.sha }}`
            **Author:** ${{ github.actor }}
            **Message:** ${{ github.event.head_commit.message }}
            
            üöÄ Deployment completed successfully!
            [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
