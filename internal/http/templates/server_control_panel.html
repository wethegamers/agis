<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Server Console - {{.ServerName}} | WeTheGamers</title>
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/dist/tabler-icons.min.css" rel="stylesheet"/>
    <!-- Xterm.js for terminal -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }
      .terminal-container {
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
        height: 500px;
      }
      .terminal-header {
        background: #0f172a;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #334155;
      }
      .terminal-dots {
        display: flex;
        gap: 6px;
      }
      .terminal-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      .dot-red { background: #ef4444; }
      .dot-yellow { background: #f59e0b; }
      .dot-green { background: #10b981; }
      #terminal {
        padding: 20px;
        height: calc(100% - 48px);
      }
      .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
      }
      .stat-box.cpu { background: linear-gradient(135deg, #206bc4 0%, #1a5aa8 100%); }
      .stat-box.memory { background: linear-gradient(135deg, #d63939 0%, #b12828 100%); }
      .stat-box.network { background: linear-gradient(135deg, #f59f00 0%, #d38300 100%); }
      .stat-box.disk { background: linear-gradient(135deg, #2fb344 0%, #248f36 100%); }
      .file-browser {
        max-height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
      }
      .file-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .file-item:hover {
        background: #e9ecef;
      }
      .file-icon {
        margin-right: 12px;
        font-size: 20px;
      }
      .action-btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .metric-gauge {
        width: 100px;
        height: 100px;
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- Navbar -->
      <header class="navbar navbar-expand-md navbar-dark d-print-none" style="background: #1e293b;">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
            <a href="/">
              <span class="avatar bg-primary text-white">WTG</span>
              <span class="text-white ms-2">WeTheGamers</span>
            </a>
          </h1>
          <div class="navbar-nav flex-row order-md-last">
            <div class="d-none d-md-flex me-3">
              <a href="/dashboard" class="btn btn-ghost-secondary text-white">
                <i class="ti ti-arrow-left icon"></i>
                Back to Dashboard
              </a>
            </div>
            <div class="nav-item dropdown">
              <a href="#" class="nav-link d-flex lh-1 text-reset p-0 text-white" data-bs-toggle="dropdown">
                <span class="avatar avatar-sm bg-primary-lt">{{substr .UserID 0 2}}</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end">
                <a href="/profile" class="dropdown-item">Profile</a>
                <a href="/logout" class="dropdown-item">Logout</a>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none" style="background: #f8f9fa;">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <div class="page-pretitle">
                  <span class="badge bg-{{if eq .Status "running"}}success{{else if eq .Status "stopped"}}secondary{{else}}warning{{end}} me-2">
                    {{.Status}}
                  </span>
                  {{.GameType}}
                </div>
                <h2 class="page-title">
                  <i class="ti ti-server me-2"></i>{{.ServerName}}
                </h2>
                <div class="text-secondary small mt-1">
                  {{if .Address}}{{.Address}}:{{.Port}}{{else}}Server starting...{{end}}
                </div>
              </div>
              <div class="col-auto ms-auto d-print-none">
                <div class="action-btn-group">
                  {{if eq .Status "running"}}
                  <button class="btn btn-warning" onclick="restartServer()">
                    <i class="ti ti-refresh icon"></i>
                    Restart
                  </button>
                  <button class="btn btn-danger" onclick="stopServer()">
                    <i class="ti ti-player-pause icon"></i>
                    Stop
                  </button>
                  {{else if eq .Status "stopped"}}
                  <button class="btn btn-success" onclick="startServer()">
                    <i class="ti ti-player-play icon"></i>
                    Start
                  </button>
                  {{end}}
                  <div class="btn-group">
                    <button class="btn btn-ghost-secondary dropdown-toggle" data-bs-toggle="dropdown">
                      <i class="ti ti-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                      <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modal-settings">
                        <i class="ti ti-settings me-2"></i>Settings
                      </a>
                      <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modal-backup">
                        <i class="ti ti-download me-2"></i>Backup
                      </a>
                      <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modal-schedule">
                        <i class="ti ti-clock me-2"></i>Schedule
                      </a>
                      <div class="dropdown-divider"></div>
                      <a href="#" class="dropdown-item text-danger" onclick="deleteServer()">
                        <i class="ti ti-trash me-2"></i>Delete Server
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Page body -->
        <div class="page-body">
          <div class="container-xl">
            
            <!-- Real-time Stats -->
            <div class="row row-cards mb-3">
              <div class="col-sm-6 col-lg-3">
                <div class="stat-box cpu">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <div class="h1 mb-0">{{.CPU}}%</div>
                      <div class="opacity-75">CPU Usage</div>
                    </div>
                    <i class="ti ti-cpu" style="font-size: 40px; opacity: 0.5;"></i>
                  </div>
                  <div class="progress progress-sm bg-white-50">
                    <div class="progress-bar" style="width: {{.CPU}}%"></div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="stat-box memory">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <div class="h1 mb-0">{{.Memory}}%</div>
                      <div class="opacity-75">Memory</div>
                    </div>
                    <i class="ti ti-database" style="font-size: 40px; opacity: 0.5;"></i>
                  </div>
                  <div class="progress progress-sm bg-white-50">
                    <div class="progress-bar" style="width: {{.Memory}}%"></div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="stat-box network">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <div class="h1 mb-0">{{.NetworkIO}}</div>
                      <div class="opacity-75">Network MB/s</div>
                    </div>
                    <i class="ti ti-network" style="font-size: 40px; opacity: 0.5;"></i>
                  </div>
                  <div class="text-white-50 small">
                    ↓ {{.NetworkIn}} MB/s • ↑ {{.NetworkOut}} MB/s
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="stat-box disk">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <div class="h1 mb-0">{{.DiskUsage}}%</div>
                      <div class="opacity-75">Disk Usage</div>
                    </div>
                    <i class="ti ti-device-sd-card" style="font-size: 40px; opacity: 0.5;"></i>
                  </div>
                  <div class="text-white-50 small">
                    {{.DiskUsedGB}} GB / {{.DiskTotalGB}} GB
                  </div>
                </div>
              </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                      <li class="nav-item">
                        <a href="#tab-console" class="nav-link active" data-bs-toggle="tab">
                          <i class="ti ti-terminal me-2"></i>Console
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="#tab-files" class="nav-link" data-bs-toggle="tab">
                          <i class="ti ti-folder me-2"></i>Files
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="#tab-players" class="nav-link" data-bs-toggle="tab">
                          <i class="ti ti-users me-2"></i>Players ({{.OnlinePlayers}})
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="#tab-plugins" class="nav-link" data-bs-toggle="tab">
                          <i class="ti ti-puzzle me-2"></i>Plugins
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="#tab-backups" class="nav-link" data-bs-toggle="tab">
                          <i class="ti ti-archive me-2"></i>Backups
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="#tab-logs" class="nav-link" data-bs-toggle="tab">
                          <i class="ti ti-file-text me-2"></i>Logs
                        </a>
                      </li>
                    </ul>
                  </div>
                  <div class="card-body">
                    <div class="tab-content">
                      
                      <!-- Console Tab -->
                      <div class="tab-pane active show" id="tab-console">
                        <div class="terminal-container">
                          <div class="terminal-header">
                            <div class="terminal-dots">
                              <span class="terminal-dot dot-red"></span>
                              <span class="terminal-dot dot-yellow"></span>
                              <span class="terminal-dot dot-green"></span>
                            </div>
                            <div class="text-white-50 font-monospace small">
                              root@{{.ServerName}}:~#
                            </div>
                            <div class="btn-list">
                              <button class="btn btn-sm btn-ghost-secondary text-white" onclick="clearTerminal()">
                                <i class="ti ti-trash"></i>
                              </button>
                              <button class="btn btn-sm btn-ghost-secondary text-white" onclick="downloadLogs()">
                                <i class="ti ti-download"></i>
                              </button>
                            </div>
                          </div>
                          <div id="terminal"></div>
                        </div>
                        <div class="mt-3">
                          <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="console-input" placeholder="Type command..." onkeypress="handleCommand(event)">
                            <button class="btn btn-primary" onclick="sendCommand()">
                              <i class="ti ti-send"></i> Send
                            </button>
                          </div>
                          <div class="mt-2">
                            <div class="btn-list">
                              <button class="btn btn-sm" onclick="quickCommand('help')">help</button>
                              <button class="btn btn-sm" onclick="quickCommand('list')">list</button>
                              <button class="btn btn-sm" onclick="quickCommand('save-all')">save-all</button>
                              <button class="btn btn-sm" onclick="quickCommand('whitelist list')">whitelist</button>
                              <button class="btn btn-sm" onclick="quickCommand('op')">op</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Files Tab -->
                      <div class="tab-pane" id="tab-files">
                        <div class="d-flex justify-content-between mb-3">
                          <div>
                            <h3 class="mb-0">Server Files</h3>
                            <div class="text-secondary small">Current path: /server/{{.ServerName}}/</div>
                          </div>
                          <div class="btn-list">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-upload">
                              <i class="ti ti-upload"></i> Upload
                            </button>
                            <button class="btn">
                              <i class="ti ti-folder-plus"></i> New Folder
                            </button>
                          </div>
                        </div>
                        <div class="file-browser">
                          {{range .Files}}
                          <div class="file-item">
                            <div class="file-icon">
                              {{if .IsDirectory}}
                              <i class="ti ti-folder text-warning"></i>
                              {{else}}
                              <i class="ti ti-file text-secondary"></i>
                              {{end}}
                            </div>
                            <div class="flex-fill">
                              <div class="font-weight-medium">{{.Name}}</div>
                              <div class="text-secondary small">{{.Size}} • Modified {{.Modified}}</div>
                            </div>
                            <div class="btn-list">
                              <button class="btn btn-sm btn-icon" onclick="downloadFile('{{.Path}}')">
                                <i class="ti ti-download"></i>
                              </button>
                              <button class="btn btn-sm btn-icon" onclick="editFile('{{.Path}}')">
                                <i class="ti ti-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-icon text-danger" onclick="deleteFile('{{.Path}}')">
                                <i class="ti ti-trash"></i>
                              </button>
                            </div>
                          </div>
                          {{else}}
                          <div class="text-center text-secondary py-5">
                            <i class="ti ti-folder-off" style="font-size: 48px;"></i>
                            <p class="mt-2">No files found</p>
                          </div>
                          {{end}}
                        </div>
                      </div>

                      <!-- Players Tab -->
                      <div class="tab-pane" id="tab-players">
                        <div class="table-responsive">
                          <table class="table card-table table-vcenter">
                            <thead>
                              <tr>
                                <th>Player</th>
                                <th>Status</th>
                                <th>Ping</th>
                                <th>Playtime</th>
                                <th>Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {{range .Players}}
                              <tr>
                                <td>
                                  <div class="d-flex align-items-center">
                                    <span class="avatar avatar-sm me-2" style="background-image: url(https://crafatar.com/avatars/{{.UUID}}?size=40)"></span>
                                    <div>
                                      <div class="font-weight-medium">{{.Name}}</div>
                                      <div class="text-secondary small">{{.UUID}}</div>
                                    </div>
                                  </div>
                                </td>
                                <td>
                                  <span class="badge bg-{{if .Online}}success{{else}}secondary{{end}}">
                                    {{if .Online}}Online{{else}}Offline{{end}}
                                  </span>
                                </td>
                                <td>{{.Ping}}ms</td>
                                <td>{{.Playtime}}</td>
                                <td>
                                  <div class="btn-list">
                                    <button class="btn btn-sm" onclick="kickPlayer('{{.Name}}')">Kick</button>
                                    <button class="btn btn-sm" onclick="banPlayer('{{.Name}}')">Ban</button>
                                  </div>
                                </td>
                              </tr>
                              {{else}}
                              <tr>
                                <td colspan="5" class="text-center text-secondary py-5">
                                  <i class="ti ti-user-off" style="font-size: 48px;"></i>
                                  <p class="mt-2">No players online</p>
                                </td>
                              </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <!-- Plugins Tab -->
                      <div class="tab-pane" id="tab-plugins">
                        <div class="d-flex justify-content-between mb-3">
                          <h3>Installed Plugins</h3>
                          <button class="btn btn-primary">
                            <i class="ti ti-plus"></i> Install Plugin
                          </button>
                        </div>
                        <div class="row g-3">
                          {{range .Plugins}}
                          <div class="col-md-6">
                            <div class="card">
                              <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                  <div>
                                    <h4 class="card-title">{{.Name}}</h4>
                                    <div class="text-secondary">Version {{.Version}}</div>
                                  </div>
                                  <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" {{if .Enabled}}checked{{end}}>
                                  </div>
                                </div>
                                <p class="text-secondary mt-2">{{.Description}}</p>
                                <div class="btn-list mt-3">
                                  <button class="btn btn-sm">Configure</button>
                                  <button class="btn btn-sm text-danger">Remove</button>
                                </div>
                              </div>
                            </div>
                          </div>
                          {{else}}
                          <div class="col-12">
                            <div class="text-center text-secondary py-5">
                              <i class="ti ti-puzzle-off" style="font-size: 48px;"></i>
                              <p class="mt-2">No plugins installed</p>
                            </div>
                          </div>
                          {{end}}
                        </div>
                      </div>

                      <!-- Backups Tab -->
                      <div class="tab-pane" id="tab-backups">
                        <div class="d-flex justify-content-between mb-3">
                          <h3>Server Backups</h3>
                          <button class="btn btn-primary" onclick="createBackup()">
                            <i class="ti ti-device-floppy"></i> Create Backup
                          </button>
                        </div>
                        <div class="table-responsive">
                          <table class="table">
                            <thead>
                              <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Created</th>
                                <th>Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              {{range .Backups}}
                              <tr>
                                <td>{{.Name}}</td>
                                <td>{{.Size}}</td>
                                <td>{{.CreatedAt}}</td>
                                <td>
                                  <div class="btn-list">
                                    <button class="btn btn-sm" onclick="restoreBackup('{{.ID}}')">Restore</button>
                                    <button class="btn btn-sm" onclick="downloadBackup('{{.ID}}')">Download</button>
                                    <button class="btn btn-sm text-danger" onclick="deleteBackup('{{.ID}}')">Delete</button>
                                  </div>
                                </td>
                              </tr>
                              {{else}}
                              <tr>
                                <td colspan="4" class="text-center text-secondary py-5">
                                  <i class="ti ti-archive-off" style="font-size: 48px;"></i>
                                  <p class="mt-2">No backups yet</p>
                                </td>
                              </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <!-- Logs Tab -->
                      <div class="tab-pane" id="tab-logs">
                        <div class="mb-3">
                          <div class="btn-list">
                            <button class="btn btn-sm btn-primary" onclick="downloadLogs()">
                              <i class="ti ti-download"></i> Download All Logs
                            </button>
                            <button class="btn btn-sm" onclick="clearLogs()">
                              <i class="ti ti-trash"></i> Clear Logs
                            </button>
                          </div>
                        </div>
                        <div class="card">
                          <div class="card-body">
                            <pre class="mb-0" style="max-height: 400px; overflow-y: auto;"><code>{{range .LogEntries}}{{.}}
{{end}}</code></pre>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script>
      // Initialize terminal
      const term = new Terminal({
        cursorBlink: true,
        theme: {
          background: '#1e293b',
          foreground: '#94a3b8',
          cursor: '#94a3b8'
        }
      });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal'));
      fitAddon.fit();

      // WebSocket connection for real-time logs
      const ws = new WebSocket('ws://' + window.location.host + '/api/v1/servers/{{.ServerID}}/console');
      ws.onmessage = (event) => {
        term.writeln(event.data);
      };

      function sendCommand() {
        const input = document.getElementById('console-input');
        const command = input.value;
        if (command) {
          ws.send(JSON.stringify({ command }));
          term.writeln('> ' + command);
          input.value = '';
        }
      }

      function handleCommand(event) {
        if (event.key === 'Enter') {
          sendCommand();
        }
      }

      function quickCommand(cmd) {
        document.getElementById('console-input').value = cmd;
        sendCommand();
      }

      function clearTerminal() {
        term.clear();
      }

      // Server control functions
      function startServer() {
        fetch('/api/v1/servers/{{.ServerID}}/start', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }).then(() => location.reload());
      }

      function stopServer() {
        if (!confirm('Stop this server?')) return;
        fetch('/api/v1/servers/{{.ServerID}}/stop', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }).then(() => location.reload());
      }

      function restartServer() {
        if (!confirm('Restart this server?')) return;
        fetch('/api/v1/servers/{{.ServerID}}/restart', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }).then(() => location.reload());
      }

      function deleteServer() {
        if (!confirm('Delete this server permanently? This cannot be undone.')) return;
        fetch('/api/v1/servers/{{.ServerID}}', {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }).then(() => window.location.href = '/dashboard');
      }

      // Auto-refresh stats every 5 seconds
      setInterval(() => {
        fetch('/api/v1/servers/{{.ServerID}}')
          .then(res => res.json())
          .then(data => {
            // Update stats in real-time
          });
      }, 5000);
    </script>
  </body>
</html>
