apiVersion: v1
kind: ConfigMap
metadata:
  name: webhook-proxy-code
  namespace: default
data:
  github-discord-webhook-proxy.py: |
    #!/usr/bin/env python3
    """
    GitHub to Discord Webhook Proxy
    Converts GitHub webhook events to Discord-compatible messages
    """

    import json
    import requests
    from http.server import HTTPServer, BaseHTTPRequestHandler
    import os
    from datetime import datetime

    DISCORD_WEBHOOK_URL = os.getenv('DISCORD_WEBHOOK_URL', "https://discord.com/api/webhooks/1389136910252904509/m84UqkOAU5UJjnPMWdJ17L5CJ-YzKaSzuD6QSjQw9_RuL-O9abqbLK2_VE2Krsj9wLW_")

    class GitHubToDiscordHandler(BaseHTTPRequestHandler):
        def do_POST(self):
            try:
                content_length = int(self.headers['Content-Length'])
                post_data = self.rfile.read(content_length)
                github_event = json.loads(post_data.decode('utf-8'))
                
                # Get GitHub event type
                event_type = self.headers.get('X-GitHub-Event', 'unknown')
                
                # Convert GitHub event to Discord message
                discord_message = self.convert_to_discord(github_event, event_type)
                
                if discord_message:
                    # Send to Discord
                    response = requests.post(DISCORD_WEBHOOK_URL, json=discord_message)
                    if response.status_code == 204:
                        self.send_response(200)
                        self.end_headers()
                        self.wfile.write(b'OK')
                    else:
                        print(f"Discord API error: {response.status_code} - {response.text}")
                        self.send_response(500)
                        self.end_headers()
                else:
                    # No message to send (unsupported event)
                    self.send_response(200)
                    self.end_headers()
                    self.wfile.write(b'Event ignored')
                    
            except Exception as e:
                print(f"Error processing webhook: {e}")
                self.send_response(500)
                self.end_headers()
        
        def do_GET(self):
            # Health check endpoint
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b'GitHub to Discord Webhook Proxy - OK')
        
        def convert_to_discord(self, github_event, event_type):
            """Convert GitHub webhook event to Discord message format"""
            
            # Common fields
            repo_name = github_event.get('repository', {}).get('full_name', 'Unknown')
            repo_url = github_event.get('repository', {}).get('html_url', '')
            
            # Push event
            if event_type == 'push':
                ref = github_event.get('ref', '')
                branch = ref.replace('refs/heads/', '') if ref.startswith('refs/heads/') else ref
                pusher = github_event.get('pusher', {}).get('name', 'Unknown')
                commits = github_event.get('commits', [])
                
                if commits:
                    commit_messages = []
                    for commit in commits[:3]:  # Show max 3 commits
                        msg = commit.get('message', '').split('\n')[0]  # First line only
                        author = commit.get('author', {}).get('name', 'Unknown')
                        commit_messages.append(f"‚Ä¢ `{commit['id'][:7]}` {msg} - {author}")
                    
                    commits_text = '\n'.join(commit_messages)
                    if len(commits) > 3:
                        commits_text += f"\n... and {len(commits) - 3} more commits"
                    
                    return {
                        "embeds": [{
                            "title": f"üöÄ New push to {branch}",
                            "description": f"**{pusher}** pushed {len(commits)} commit(s) to **{repo_name}**\n\n{commits_text}",
                            "color": 0x28a745,  # Green
                            "url": github_event.get('compare', repo_url),
                            "footer": {
                                "text": f"{repo_name} ‚Ä¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                            }
                        }]
                    }
            
            # Pull Request events
            elif event_type == 'pull_request':
                action = github_event.get('action')
                pr = github_event.get('pull_request', {})
                pr_number = pr.get('number')
                pr_title = pr.get('title')
                pr_url = pr.get('html_url')
                author = pr.get('user', {}).get('login', 'Unknown')
                
                action_colors = {
                    'opened': 0x28a745,    # Green
                    'closed': 0x6f42c1,    # Purple
                    'merged': 0x6f42c1,    # Purple
                    'reopened': 0xffc107,  # Yellow
                    'ready_for_review': 0x17a2b8,  # Blue
                }
                
                action_emojis = {
                    'opened': 'üÜï',
                    'closed': '‚ùå',
                    'merged': 'üéâ',
                    'reopened': 'üîÑ',
                    'ready_for_review': 'üëÄ',
                }
                
                if action in ['opened', 'closed', 'reopened', 'ready_for_review']:
                    return {
                        "embeds": [{
                            "title": f"{action_emojis.get(action, 'üìù')} Pull Request {action}",
                            "description": f"**#{pr_number}: {pr_title}**\n\nBy: {author}",
                            "color": action_colors.get(action, 0x0366d6),
                            "url": pr_url,
                            "footer": {
                                "text": f"{repo_name} ‚Ä¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                            }
                        }]
                    }
            
            # Issue events
            elif event_type == 'issues':
                action = github_event.get('action')
                issue = github_event.get('issue', {})
                issue_number = issue.get('number')
                issue_title = issue.get('title')
                issue_url = issue.get('html_url')
                author = issue.get('user', {}).get('login', 'Unknown')
                
                if action in ['opened', 'closed', 'reopened']:
                    action_emojis = {
                        'opened': 'üêõ',
                        'closed': '‚úÖ',
                        'reopened': 'üîÑ'
                    }
                    
                    action_colors = {
                        'opened': 0xd73a49,    # Red
                        'closed': 0x28a745,    # Green  
                        'reopened': 0xffc107   # Yellow
                    }
                    
                    return {
                        "embeds": [{
                            "title": f"{action_emojis.get(action, 'üìù')} Issue {action}",
                            "description": f"**#{issue_number}: {issue_title}**\n\nBy: {author}",
                            "color": action_colors.get(action, 0xd73a49),
                            "url": issue_url,
                            "footer": {
                                "text": f"{repo_name} ‚Ä¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                            }
                        }]
                    }
            
            # Release events
            elif event_type == 'release':
                action = github_event.get('action')
                release = github_event.get('release', {})
                
                if action == 'published':
                    tag_name = release.get('tag_name')
                    release_name = release.get('name', tag_name)
                    release_url = release.get('html_url')
                    author = release.get('author', {}).get('login', 'Unknown')
                    
                    return {
                        "embeds": [{
                            "title": "üéâ New Release Published",
                            "description": f"**{release_name}** ({tag_name})\n\nBy: {author}",
                            "color": 0x28a745,  # Green
                            "url": release_url,
                            "footer": {
                                "text": f"{repo_name} ‚Ä¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                            }
                        }]
                    }
            
            # Star events
            elif event_type == 'star':
                action = github_event.get('action')
                if action == 'created':
                    starrer = github_event.get('sender', {}).get('login', 'Someone')
                    stars_count = github_event.get('repository', {}).get('stargazers_count', 0)
                    
                    return {
                        "embeds": [{
                            "title": "‚≠ê New Star!",
                            "description": f"**{starrer}** starred **{repo_name}**\n\nTotal stars: {stars_count}",
                            "color": 0xffc107,  # Yellow
                            "url": repo_url,
                            "footer": {
                                "text": f"{repo_name} ‚Ä¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
                            }
                        }]
                    }
            
            # Return None for unsupported events
            return None

    if __name__ == "__main__":
        port = int(os.environ.get('PORT', 8080))
        server = HTTPServer(('0.0.0.0', port), GitHubToDiscordHandler)
        print(f"GitHub to Discord webhook proxy running on port {port}")
        server.serve_forever()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-discord-proxy
  namespace: default
  labels:
    app: github-discord-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: github-discord-proxy
  template:
    metadata:
      labels:
        app: github-discord-proxy
    spec:
      containers:
      - name: webhook-proxy
        image: python:3.9-slim
        command: ["/bin/bash"]
        args: ["-c", "pip install requests && python /app/github-discord-webhook-proxy.py"]
        ports:
        - containerPort: 8080
        env:
        - name: DISCORD_WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ci-secrets
              key: DISCORD_WEBHOOK_URL
        - name: PORT
          value: "8080"
        volumeMounts:
        - name: webhook-code
          mountPath: /app
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 10
      volumes:
      - name: webhook-code
        configMap:
          name: webhook-proxy-code
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: github-discord-proxy
  namespace: default
  labels:
    app: github-discord-proxy
spec:
  selector:
    app: github-discord-proxy
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: github-discord-proxy
  namespace: default
  annotations:
    kubernetes.io/ingress.class: "traefik"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    traefik.ingress.kubernetes.io/router.middlewares: default-headers@kubernetescrd
spec:
  tls:
  - hosts:
    - github-webhook.euw.wtgg.org
    secretName: github-webhook-tls
  rules:
  - host: github-webhook.euw.wtgg.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: github-discord-proxy
            port:
              number: 80
